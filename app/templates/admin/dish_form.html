{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container pt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3>{{ title }}</h3>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Название блюда</label>
                                <input type="text" name="name" class="form-control" value="{{ dish.name if dish else '' }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Цена (₽)</label>
                                <input type="number" step="0.01" name="price" class="form-control" value="{{ dish.price if dish else '' }}" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Категория</label>
                            <select name="category_id" class="form-select" required>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}" {% if dish and dish.category_id == cat.id %}selected{% endif %}>
                                    {{ cat.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Картинка</label>
                            <div class="input-group">
                                <input type="text" name="image_path" id="imagePathInput" class="form-control" 
                                       value="{{ dish.image_path if dish else '' }}" placeholder="images/example.jpg" required readonly>
                                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#imageModal">
                                    Выбрать
                                </button>
                            </div>
                            {% if dish and dish.image_path %}
                            <div class="mt-2">
                                <small class="text-muted">Текущее изображение:</small><br>
                                <img src="{{ url_for('static', filename=dish.image_path) }}" class="img-thumbnail" style="max-height: 200px;">
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Описание (необязательно)</label>
                            <textarea name="description" class="form-control" rows="4">{{ dish.description if dish else '' }}</textarea>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('admin.admin_dishes') }}" class="btn btn-secondary me-md-2">Отмена</a>
                            <button type="submit" class="btn btn-primary">Сохранить</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно выбора картинки -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Выберите изображение из static/images/</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-3">
                    <div class="text-center text-muted py-5 col-12">
                        <div class="spinner-border" role="status"><span class="visually-hidden">Загрузка...</span></div>
                        <p class="mt-2">Загрузка изображений...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const modalBody = document.querySelector('#imageModal .modal-body .row');

    fetch('/admin/list-images')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            modalBody.innerHTML = '';
            if (data.error) {
                modalBody.innerHTML = `<p class="text-center text-danger col-12">${data.error}</p>`;
                return;
            }
            if (data.images.length === 0) {
                modalBody.innerHTML = '<p class="text-center text-muted col-12">Картинок не найдено в папке static/images/</p>';
                return;
            }

            data.images.forEach(img => {
                const col = document.createElement('div');
                col.className = 'col';

                const card = document.createElement('div');
                card.className = 'card border-0 shadow-sm';
                card.style.cursor = 'pointer';

                const image = document.createElement('img');
                image.src = '/static/images/' + img;
                image.alt = img;
                image.className = 'card-img-top';
                image.style.height = '150px';
                image.style.objectFit = 'cover';

                const cardBody = document.createElement('div');
                cardBody.className = 'card-body py-2 text-center';
                const title = document.createElement('small');
                title.textContent = img;
                title.className = 'text-muted text-truncate d-block';
                cardBody.appendChild(title);

                card.appendChild(image);
                card.appendChild(cardBody);

                card.onclick = function () {
                    document.getElementById('imagePathInput').value = 'images/' + img;
                    bootstrap.Modal.getInstance(document.getElementById('imageModal')).hide();
                };

                col.appendChild(card);
                modalBody.appendChild(col);
            });
        })
        .catch(err => {
            modalBody.innerHTML = '<p class="text-center text-danger col-12">Ошибка загрузки изображений</p>';
            console.error('Fetch error:', err);
        });
});
</script>
{% endblock %}